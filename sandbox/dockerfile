# 使用 Python 官方镜像作为基础镜像
FROM python:3.10.13-slim-bullseye

RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo 'Asia/Shanghai' >/etc/timezone

RUN mkdir -p /app && chown nobody:nogroup /app

WORKDIR /app
COPY . /app

RUN mkdir -p /app/shared && chown nobody:nogroup /app/shared

RUN pip install poetry -i https://mirrors.aliyun.com/pypi/simple/ --trusted-host mirrors.aliyun.com
RUN poetry config virtualenvs.create false
RUN poetry lock --no-update
RUN poetry install

# 通过代理安装 openacv 依赖
ENV http_proxy="http://172.17.0.1:7890"
ENV https_proxy="https://172.17.0.1:7890"

RUN apt-get update && \
    apt-get install -y libgl1-mesa-glx && \
    apt-get install -y libglib2.0-0 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 清除设置的代理
ENV http_proxy=""
ENV https_proxy=""

RUN chmod -R 777 /app/shared

USER nobody

CMD ["bash"]
